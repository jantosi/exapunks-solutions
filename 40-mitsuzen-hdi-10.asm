;THIS ONE IS MORE CONCE-
;PTUAL THAN EFFECTIVE:
;INSTEAD OF EXA-BASED
;MESSAGING, WALKING BACK
;AND FORTH, I ASSIGNED
;A DELAY TO EACH NODE
;AND USED M REGISTER.
;
;IT'S A SIMPLE TIME
;BASED MULTIPLEXING.
;


;NV
;BFS + COPIER EXA
;SET DEFAULT MODE: LOCAL

LINK 800
MAKE
COPY 0 F
;WE'RE COMING FROM -1,
;RELATIVELY TO THE NEW
;ROOM.
COPY -1 X

MARK GOFORTH
;TWO NUMBERS IN FILE
;BASE TIMER FOR CHILDREN
;(MUL 4)
;BASE TIMER FOR THIS 
;UNIT 
SEEK -9999
COPY F F
SEEK -9999
MULI F 4 T
SEEK -9999
COPY T F

;SPAWN UP TO 3 NEW EXAS
;BUT NOT WHERE WE CAME
;FROM.
MARK NEXTDIR_NEG1
TEST X = -1
TJMP NEXTDIR_POS1
COPY X T
COPY -1 X
REPL SPAWN
SEEK -9999
ADDI F 1 X
SEEK -9999
COPY X F
COPY X M
COPY T X

MARK NEXTDIR_POS1
TEST X = 1
TJMP NEXTDIR_NEG3
COPY X T
COPY 1 X
REPL SPAWN
SEEK -9999
ADDI F 1 X
SEEK -9999
COPY X F
COPY X M
COPY T X

MARK NEXTDIR_NEG3
TEST X = -3
TJMP NEXTDIR_POS3
COPY X T
COPY -3 X
REPL SPAWN
SEEK -9999
ADDI F 1 X
SEEK -9999
COPY X F
COPY X M
COPY T X

MARK NEXTDIR_POS3
TEST X = 3
TJMP DONEDIRS
COPY X T
COPY 3 X
REPL SPAWN
SEEK -9999
ADDI F 1 X
SEEK -9999
COPY X F
COPY X M
COPY T X


MARK DONEDIRS
;GRAB TIME UNTIL BROAD-
;CAST WINDOW
SEEK -9999
SEEK 1
COPY F T
MULI T 6 T;INCREASE SPAC
ADDI T 1 T;PREVENT ZERO
;SIMPLIFIES LOOP

;KEEP COUNTING DOWN
MARK COUNTDOWN
SUBI T 1 T
TJMP COUNTDOWN
;HALT;TEST
;SEND VALUES AND DIE

MODE ;GLOBAL
WIPE
COPY #NERV M
HOST M
HALT

MARK SPAWN
;TTL TIMER
COPY M T

LINK X

MAKE
COPY T F

;IF WE LINKED TO 3,
;WAY BACK THERE IS -3.
;PUT IT IN X TO AVOID
;SENDING MORE EXAS THERE
MULI X -1 X
JUMP GOFORTH




;LI




;LISTENER EXA
;SET DEFAULT MODE:GLOBAL

MAKE

MARK LISTEN
TEST MRD
TJMP WRITE
ADDI X 1 X
;IDLING FOR OVER 200
;CYCLES? GO SORT THE
;DATA
TEST X > 4100
TJMP GIVEUP
JUMP LISTEN
MARK WRITE
COPY M F
COPY M F
JUMP LISTEN


MARK GIVEUP
;TODO SORT
REPL SORTEDRECEIVER

;NAIVE N^2 SORT.
;FIND LOWEST, TRANSFER
;PAIR, AND SO ON.
MARK NEXTLOWEST
SEEK -9999
SEEK 1

TEST EOF
TJMP DONESORT

COPY F X;INIT
SEEK -1;

MARK FINDLOWEST
TEST EOF
TJMP FOUNDLOWEST
TEST F < X
SEEK 1
FJMP FINDLOWEST
TEST EOF
SEEK -1
TJMP SKIPSEEK
SEEK -1
MARK SKIPSEEK
COPY F X
SEEK 1
JUMP FINDLOWEST

;NAVIGATE AGAIN TO ERASE
;FROM FILE AND
;TRANSFER OUT
MARK FOUNDLOWEST
SEEK -9999
SEEK 1
MARK FINDANDERASE
TEST EOF
TJMP GIVEUP 
TEST F = X
FJMP FINDANDERASE
;FOUND HOSTNAME
SEEK -2
COPY F X;VALUE
COPY F M;HOSTNAME
COPY X M;SEND VALUE
SEEK -2
VOID F;OVERWRITE
VOID F
;GO BACK, FIND NEXT
;LOWEST
JUMP NEXTLOWEST


JUMP GIVEUP


MARK DONESORT
WIPE
COPY -9999 M;SEND EOF
HALT


MARK SORTEDRECEIVER
MAKE
;TODO
MARK COPYMORE
COPY M X
TEST X = -9999
TJMP DIE
COPY X F
JUMP COPYMORE
MARK DIE
